
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>bimpy.bStack &#8212; bImPy 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bimpy.bStack</h1><div class="highlight"><pre>
<span></span><span class="c1"># Robert Cudmore</span>
<span class="c1"># 20190420</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">skimage</span>
<span class="kn">import</span> <span class="nn">tifffile</span>
<span class="kn">import</span> <span class="nn">bioformats</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logLevel</span> <span class="o">=</span> <span class="s1">&#39;DEBUG&#39;</span> <span class="c1">#(&#39;ERROR, WARNING&#39;, &#39;INFO&#39;, &#39;DEBUG&#39;)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;bimpy.log&#39;</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
	<span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
	<span class="n">level</span><span class="o">=</span><span class="n">logLevel</span><span class="p">,</span>
	<span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(module)s</span><span class="s1">.</span><span class="si">%(funcName)s</span><span class="s1">() line </span><span class="si">%(lineno)d</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">bimpy</span>

<div class="viewcode-block" id="bLockFile"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bLockFile">[docs]</a><span class="k">class</span> <span class="nc">bLockFile</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a .lock file while processing an input file.</span>
<span class="sd">	Other programs (e.g. Igor Pro) use this to determine if work is being done on an input file</span>
<span class="sd">	   and can wait until .lock file is gone (e.g. work is done)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filePath</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">myLockFile</span> <span class="o">=</span> <span class="n">filePath</span> <span class="o">+</span> <span class="s1">&#39;.lock&#39;</span>
		<span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myLockFile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
		<span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="bLockFile.unlock"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bLockFile.unlock">[docs]</a>	<span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myLockFile</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="bStack"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack">[docs]</a><span class="k">class</span> <span class="nc">bStack</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Manages a 3D image stack or time-series movie of images</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">loadImages</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;constructor&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="c1"># path to file</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">currentSlice</span> <span class="o">=</span> <span class="mi">0</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">fileNameWithoutExtension</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
			<span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fileNameWithoutExtension</span><span class="p">,</span> <span class="n">tmpExtension</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#StackHeader.StackHeader(self.path)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="c1"># load vesselucida analysis from .xml file</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">slabList</span> <span class="o">=</span> <span class="n">bimpy</span><span class="o">.</span><span class="n">bSlabList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slabList</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">slabList</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="c1"># load image data</span>
		<span class="k">if</span> <span class="n">loadImages</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">loadStack</span><span class="p">()</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">numChannels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">numChannels</span>
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">numImages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">numImages</span>
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">pixelsPerLine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">pixelsPerLine</span>
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">linesPerFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">linesPerFrame</span>
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">xVoxel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">xVoxel</span>
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">yVoxel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">yVoxel</span>
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">zVoxel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">zVoxel</span>
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">bitDepth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">bitDepth</span>

<div class="viewcode-block" id="bStack.getHeaderVal"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.getHeaderVal">[docs]</a>	<span class="k">def</span> <span class="nf">getHeaderVal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error: bStack.getHeaderVal() did not find key &quot;&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;&quot; in self.header.header. Available keys are:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
			<span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="bStack.convert"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.convert">[docs]</a>	<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">myLock</span> <span class="o">=</span> <span class="n">bLockFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">loadHeader</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">prettyPrint</span><span class="p">()</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">loadStack</span><span class="p">()</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">saveHeader</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">saveStack</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">saveMax</span><span class="p">()</span>

		<span class="k">finally</span><span class="p">:</span>
			<span class="n">myLock</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span></div>

	<span class="c1">#</span>
	<span class="c1"># Display</span>
	<span class="c1">#</span>
<div class="viewcode-block" id="bStack.setSlice"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.setSlice">[docs]</a>	<span class="k">def</span> <span class="nf">setSlice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sliceNum</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">sliceNum</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">numImages</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">currentSlice</span> <span class="o">=</span> <span class="n">sliceNum</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning bStack.setSlice()&#39;</span><span class="p">,</span> <span class="n">sliceNum</span><span class="p">,</span> <span class="s1">&#39;but stack only has&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">numImages</span><span class="p">)</span></div>

<div class="viewcode-block" id="bStack.getImage"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.getImage">[docs]</a>	<span class="k">def</span> <span class="nf">getImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sliceNum</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="n">channelIdx</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="n">sliceNum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">sliceNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentSlice</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
			<span class="c1"># single plane image</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">channelIdx</span><span class="p">,:,:]</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">channelIdx</span><span class="p">,</span><span class="n">sliceNum</span><span class="p">,:,:]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   error: bStack.getImage() got bad stack shape:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></div>

<div class="viewcode-block" id="bStack.getSlidingZ"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.getSlidingZ">[docs]</a>	<span class="k">def</span> <span class="nf">getSlidingZ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sliceNumber</span><span class="p">,</span> <span class="n">thisStack</span><span class="p">,</span> <span class="n">upSlices</span><span class="p">,</span> <span class="n">downSlices</span><span class="p">,</span> <span class="n">minContrast</span><span class="p">,</span> <span class="n">maxContrast</span><span class="p">):</span>

		<span class="n">startSlice</span> <span class="o">=</span> <span class="n">sliceNumber</span> <span class="o">-</span> <span class="n">upSlices</span>
		<span class="k">if</span> <span class="n">startSlice</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">startSlice</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">stopSlice</span> <span class="o">=</span> <span class="n">sliceNumber</span> <span class="o">+</span> <span class="n">downSlices</span>
		<span class="k">if</span> <span class="n">stopSlice</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">numImages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">stopSlice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numImages</span> <span class="o">-</span> <span class="mi">1</span>

		<span class="k">if</span> <span class="n">thisStack</span> <span class="o">==</span> <span class="s1">&#39;ch1&#39;</span><span class="p">:</span>
			<span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">startSlice</span><span class="p">:</span><span class="n">stopSlice</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">elif</span> <span class="n">thisStack</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
			<span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagesMask</span><span class="p">[</span><span class="n">startSlice</span><span class="p">:</span><span class="n">stopSlice</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">elif</span> <span class="n">thisStack</span> <span class="o">==</span> <span class="s1">&#39;skel&#39;</span><span class="p">:</span>
			<span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagesSkel</span><span class="p">[</span><span class="n">startSlice</span><span class="p">:</span><span class="n">stopSlice</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error: getSlidingZ() got bad thisStack:&#39;</span><span class="p">,</span> <span class="n">thisStack</span><span class="p">)</span>

		<span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">setSliceContrast</span><span class="p">(</span><span class="n">sliceNumber</span><span class="p">,</span> <span class="n">minContrast</span><span class="o">=</span><span class="n">minContrast</span><span class="p">,</span> <span class="n">maxContrast</span><span class="o">=</span><span class="n">maxContrast</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">)</span></div>

<div class="viewcode-block" id="bStack.setSliceContrast"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.setSliceContrast">[docs]</a>	<span class="k">def</span> <span class="nf">setSliceContrast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sliceNumber</span><span class="p">,</span> <span class="n">thisStack</span><span class="o">=</span><span class="s1">&#39;ch1&#39;</span><span class="p">,</span> <span class="n">minContrast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxContrast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoContrast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		thisStack in [&#39;ch1&#39;, &#39;ch2&#39;, &#39;ch3&#39;, &#39;mask&#39;, &#39;skel&#39;]</span>

<span class="sd">		img: pass this in to contrast adjust an existing image, e.g. from sliding z-projection</span>

<span class="sd">		autoContrast: probably not working</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1">#print(&#39;setSliceContrast()&#39;)</span>

		<span class="c1"># we are making a copy so we can modify the contrast</span>
		<span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">thisStack</span> <span class="o">==</span> <span class="s1">&#39;ch1&#39;</span><span class="p">:</span>
				<span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">sliceNumber</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">elif</span> <span class="n">thisStack</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
				<span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagesMask</span><span class="p">[</span><span class="n">sliceNumber</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">elif</span> <span class="n">thisStack</span> <span class="o">==</span> <span class="s1">&#39;skel&#39;</span><span class="p">:</span>
				<span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagesSkel</span><span class="p">[</span><span class="n">sliceNumber</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error: setSliceContrast() got bad thisStack:&#39;</span><span class="p">,</span> <span class="n">thisStack</span><span class="p">)</span>

		<span class="c1">#print(&#39;setSliceContrast() BEFORE min:&#39;, img.min(), &#39;max:&#39;, img.max(), &#39;mean:&#39;, img.mean(), &#39;dtype:&#39;, img.dtype)</span>

		<span class="c1"># this works, removing it does not anything faster !!!</span>
		<span class="n">maxInt</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitDepth</span> <span class="o">-</span> <span class="mi">1</span>

		<span class="k">if</span> <span class="n">minContrast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">minContrast</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">if</span> <span class="n">maxContrast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">maxContrast</span> <span class="o">=</span> <span class="n">maxInt</span> <span class="c1">#2 ** self.bitDepth - 1</span>
		<span class="k">if</span> <span class="n">autoContrast</span><span class="p">:</span>
			<span class="n">minContrast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
			<span class="n">maxContrast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

		<span class="c1">#print(&#39;   setSliceContrast() sliceNumber:&#39;, sliceNumber, &#39;maxInt:&#39;, maxInt, &#39;lowContrast:&#39;, lowContrast, &#39;highContrast:&#39;, highContrast)</span>

		<span class="c1">#mult = maxInt / abs(highContrast - lowContrast)</span>
		<span class="n">denominator</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">maxContrast</span> <span class="o">-</span> <span class="n">minContrast</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">denominator</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">mult</span> <span class="o">=</span> <span class="n">maxInt</span> <span class="o">/</span> <span class="n">denominator</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">mult</span> <span class="o">=</span> <span class="n">maxInt</span>

		<span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&lt;</span> <span class="n">minContrast</span><span class="p">]</span> <span class="o">=</span> <span class="n">minContrast</span>
		<span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="n">maxContrast</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxContrast</span>
		<span class="n">img</span> <span class="o">-=</span> <span class="n">minContrast</span>

		<span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">*</span> <span class="n">mult</span>

		<span class="k">return</span> <span class="n">img</span></div>

		<span class="c1"># if i remove all from above, this is not any faster?</span>
		<span class="c1">#return self._images[sliceNumber, :, :]</span>

	<span class="k">def</span> <span class="nf">_display0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">display_min</span><span class="p">,</span> <span class="n">display_max</span><span class="p">):</span> <span class="c1"># copied from Bi Rico</span>
		<span class="c1"># Here I set copy=True in order to ensure the original image is not</span>
		<span class="c1"># modified. If you don&#39;t mind modifying the original image, you can</span>
		<span class="c1"># set copy=False or skip this step.</span>
		<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">image</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">display_min</span><span class="p">,</span> <span class="n">display_max</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
		<span class="n">image</span> <span class="o">-=</span> <span class="n">display_min</span>
		<span class="n">np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">display_max</span> <span class="o">-</span> <span class="n">display_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bitDepth</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">casting</span><span class="o">=</span><span class="s1">&#39;unsafe&#39;</span><span class="p">)</span>
		<span class="c1">#np.floor_divide(image, (display_max - display_min + 1) / 256,</span>
		<span class="c1">#				out=image, casting=&#39;unsafe&#39;)</span>
		<span class="c1">#return image.astype(np.uint8)</span>
		<span class="k">return</span> <span class="n">image</span>

	<span class="c1">#def setSliceContrast(self, sliceNumber, thisStack=&#39;ch1&#39;, minContrast=None, maxContrast=None, autoContrast=False, img=None):</span>
<div class="viewcode-block" id="bStack.getImage_ContrastEnhanced"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.getImage_ContrastEnhanced">[docs]</a>	<span class="k">def</span> <span class="nf">getImage_ContrastEnhanced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display_min</span><span class="p">,</span> <span class="n">display_max</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sliceNum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">useMaxProject</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		sliceNum: pass None to use self.currentImage</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">#lut = np.arange(2**16, dtype=&#39;uint16&#39;)</span>
		<span class="n">lut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">bitDepth</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
		<span class="n">lut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display0</span><span class="p">(</span><span class="n">lut</span><span class="p">,</span> <span class="n">display_min</span><span class="p">,</span> <span class="n">display_max</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">useMaxProject</span><span class="p">:</span>
			<span class="c1"># need to specify channel !!!!!!</span>
			<span class="c1">#print(&#39;self.maxProjectImage.shape:&#39;, self.maxProjectImage.shape, &#39;max:&#39;, np.max(self.maxProjectImage))</span>
			<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">lut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxProjectImage</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">lut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getImage</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">sliceNum</span><span class="o">=</span><span class="n">sliceNum</span><span class="p">))</span></div>

	<span class="c1">#</span>
	<span class="c1"># Loading</span>
	<span class="c1">#</span>
<div class="viewcode-block" id="bStack.loadHeader"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.loadHeader">[docs]</a>	<span class="k">def</span> <span class="nf">loadHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">bimpy</span><span class="o">.</span><span class="n">bStackHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bStack.loadHeader() did not find self.path:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="bStack.loadMax"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.loadMax">[docs]</a>	<span class="k">def</span> <span class="nf">loadMax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">convertTo8Bit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="c1">#print(&#39;bStack.loadMax() channel:&#39;, channel, &#39;self.path:&#39;, self.path)</span>
		<span class="n">fu</span> <span class="o">=</span> <span class="n">bimpy</span><span class="o">.</span><span class="n">bFileUtil</span><span class="p">()</span>
		<span class="n">maxFile</span> <span class="o">=</span> <span class="n">fu</span><span class="o">.</span><span class="n">getMaxFileFromRaw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">theChannel</span><span class="o">=</span><span class="n">channel</span><span class="p">)</span>
		<span class="c1">#print(&#39;bStack.loadMax() maxFile:&#39;, maxFile)</span>

		<span class="c1"># load the file</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">maxFile</span><span class="p">):</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loadMax() max file in:&#39;</span><span class="p">,</span> <span class="n">maxFile</span><span class="p">)</span>
			<span class="k">with</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">TiffFile</span><span class="p">(</span><span class="n">maxFile</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
				<span class="n">theArray</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">convertTo8Bit</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   convert to 8-bit&#39;</span><span class="p">)</span>
				<span class="n">theArray</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">img_as_ubyte</span><span class="p">(</span><span class="n">theArray</span><span class="p">,</span> <span class="n">force_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="c1"># need to specify channel !!!!!!</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   theArray.shape&#39;</span><span class="p">,</span> <span class="n">theArray</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">theArray</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">maxProjectImage</span> <span class="o">=</span> <span class="n">theArray</span>
			<span class="k">return</span> <span class="n">theArray</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;loadMax() ERROR max file in:&#39;</span><span class="p">,</span> <span class="n">maxFile</span><span class="p">,</span> <span class="s1">&#39;path:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="bStack.loadStack"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.loadStack">[docs]</a>	<span class="k">def</span> <span class="nf">loadStack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1">#print(&#39;   bStack.loadStack() Images:&#39;, self.numImages, &#39;pixelsPerLine:&#39;, self.pixelsPerLine, &#39;linesPerFrame:&#39;, self.linesPerFrame, &#39;path:&#39;, self.path)</span>
		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   bStack.loadStack()&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">loadHeader</span><span class="p">()</span>

		<span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linesPerFrame</span>
		<span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixelsPerLine</span>
		<span class="n">slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numImages</span>
		<span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numChannels</span>

		<span class="k">if</span> <span class="n">rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error: bStack.loadStack() --&gt;&gt; None rows&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error: bStack.loadStack() --&gt;&gt; None cols&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">slices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error: bStack.loadStack() --&gt;&gt; None slices&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error: bStack.loadStack() --&gt;&gt; None channels&#39;</span><span class="p">)</span>

		<span class="c1">#self.stack = np.zeros((channels, slices, rows, cols), dtype=np.int16)</span>

		<span class="c1">#todo: this will only work for one channel</span>

		<span class="c1"># if it is a Tiff file use tifffile, otherwise, use bioformats</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">):</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   bStack.loadStack() is using tifffile...&#39;</span><span class="p">)</span>
			<span class="k">with</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">TiffFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
				<span class="n">tag</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;XResolution&#39;</span><span class="p">]</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   XResolution tag.value:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;name:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;code:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="s1">&#39;dtype:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;valueoffset:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
					<span class="n">xVoxel</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   error, got zero tag value?&#39;</span><span class="p">)</span>
					<span class="n">xVoxel</span> <span class="o">=</span> <span class="mi">1</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   xVoxel from XResolutions:&#39;</span><span class="p">,</span> <span class="n">xVoxel</span><span class="p">)</span>

				<span class="n">tag</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;YResolution&#39;</span><span class="p">]</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   YResolution tag.value:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;name:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;code:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="s1">&#39;dtype:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;valueoffset:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">valueoffset</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
					<span class="n">yVoxel</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">tag</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   error, got zero tag value?&#39;</span><span class="p">)</span>
					<span class="n">yVoxel</span> <span class="o">=</span> <span class="mi">1</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   yVoxel from YResolutions:&#39;</span><span class="p">,</span> <span class="n">yVoxel</span><span class="p">)</span>

				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   tif.imagej_metadata:&#39;</span><span class="p">,</span> <span class="n">tif</span><span class="o">.</span><span class="n">imagej_metadata</span><span class="p">)</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   tif.tags:&#39;</span><span class="p">,</span> <span class="n">tif</span><span class="o">.</span><span class="n">is_nih</span><span class="p">)</span>
				<span class="c1">#print(&#39;   tif[0].image_description:&#39;, tif.image_description)</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   tif.nih_metadata:&#39;</span><span class="p">,</span> <span class="n">tif</span><span class="o">.</span><span class="n">nih_metadata</span><span class="p">)</span>
				<span class="n">thisChannel</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="n">loaded_shape</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span>
				<span class="n">loaded_dtype</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span><span class="o">.</span><span class="n">dtype</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      loaded_shape:&#39;</span><span class="p">,</span> <span class="n">loaded_shape</span><span class="p">,</span> <span class="s1">&#39;loaded_dtype:&#39;</span><span class="p">,</span> <span class="n">loaded_dtype</span><span class="p">)</span>
				<span class="n">newShape</span> <span class="o">=</span> <span class="p">(</span><span class="n">channels</span><span class="p">,)</span> <span class="o">+</span> <span class="n">loaded_shape</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">newShape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">loaded_dtype</span><span class="p">)</span>

				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
					<span class="c1"># single plane image</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">thisChannel</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
				<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
					<span class="c1">#3d stack</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">thisChannel</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   error: got bad shape:&#39;</span><span class="p">,</span> <span class="n">loaded_shape</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">assignToShape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      after load tiff, self.stack.shape:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   bStack.loadStack() using bioformats ...&#39;</span><span class="p">,</span> <span class="s1">&#39;channels:&#39;</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="s1">&#39;slices:&#39;</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="s1">&#39;rows:&#39;</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="s1">&#39;cols:&#39;</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
			<span class="c1">#with bioformats.GetImageReader(self.path) as reader:</span>
			<span class="k">with</span> <span class="n">bioformats</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">channelIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numChannels</span><span class="p">):</span>
					<span class="n">c</span> <span class="o">=</span> <span class="n">channelIdx</span>
					<span class="k">for</span> <span class="n">imageIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numImages</span><span class="p">):</span>
						<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stackType</span> <span class="o">==</span> <span class="s1">&#39;ZStack&#39;</span><span class="p">:</span>
							<span class="n">z</span> <span class="o">=</span> <span class="n">imageIdx</span>
							<span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
						<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stackType</span> <span class="o">==</span> <span class="s1">&#39;TSeries&#39;</span><span class="p">:</span>
							<span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
							<span class="n">t</span> <span class="o">=</span> <span class="n">imageIdx</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      ****** Error: bStack.loadStack() did not get valid self.header.stackType:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stackType</span><span class="p">)</span>
							<span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
							<span class="n">t</span> <span class="o">=</span> <span class="n">imageIdx</span>
						<span class="c1">#print(&#39;imageIdx:&#39;, imageIdx)</span>
						<span class="n">image</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># returns numpy.ndarray</span>
						<span class="c1">#image = reader.read(c=c, rescale=False) # returns numpy.ndarray</span>
						<span class="n">loaded_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># we are loading single image, this will be something like (512,512)</span>
						<span class="n">loaded_dtype</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
						<span class="n">newShape</span> <span class="o">=</span> <span class="p">(</span><span class="n">channels</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">numImages</span><span class="p">)</span> <span class="o">+</span> <span class="n">loaded_shape</span>
						<span class="c1"># resize</span>
						<span class="c1">#print(&#39;      oir loaded_shape:&#39;, loaded_shape, self.path)</span>
						<span class="k">if</span> <span class="n">channelIdx</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">imageIdx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
							<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;      loaded_shape:&#39;</span><span class="p">,</span> <span class="n">loaded_shape</span><span class="p">,</span> <span class="s1">&#39;loaded_dtype:&#39;</span><span class="p">,</span> <span class="n">loaded_dtype</span><span class="p">,</span> <span class="s1">&#39;newShape:&#39;</span><span class="p">,</span> <span class="n">newShape</span><span class="p">)</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">newShape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">loaded_dtype</span><span class="p">)</span>
						<span class="c1"># assign</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">channelIdx</span><span class="p">,</span><span class="n">imageIdx</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">image</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">assignToShape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span></div>

	<span class="c1">#</span>
	<span class="c1"># Saving</span>
	<span class="c1">#</span>
<div class="viewcode-block" id="bStack.saveHeader"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.saveHeader">[docs]</a>	<span class="k">def</span> <span class="nf">saveHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Save header as .txt file</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">savePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_makeSavePath</span><span class="p">()</span>
		<span class="n">headerFileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNameWithoutExtension</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span>
		<span class="n">headerFilePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savePath</span><span class="p">,</span> <span class="n">headerFileName</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">saveHeader</span><span class="p">(</span><span class="n">headerFilePath</span><span class="p">)</span></div>

<div class="viewcode-block" id="bStack.saveStack"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.saveStack">[docs]</a>	<span class="k">def</span> <span class="nf">saveStack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Save stack as .tif file</span>

<span class="sd">		to add meta data, see</span>
<span class="sd">		   https://github.com/CellProfiler/python-bioformats/issues/106</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1">#</span>
		<span class="c1"># save each channel using tifffile</span>
		<span class="k">for</span> <span class="n">channelIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numChannels</span><span class="p">):</span>
			<span class="n">saveFilePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_getSaveFile</span><span class="p">(</span><span class="n">channelNumber</span><span class="o">=</span><span class="n">channelIdx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
			<span class="c1"># self.stack is czxy</span>
			<span class="c1">#tifffile.imwrite(saveFilePath, self.stack[channelIdx,:,:,:], imagej=True, resolution=resolution, metadata=metadata, ijmetadata=ijmetadata)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">(</span><span class="n">saveFilePath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">channelIdx</span><span class="p">,:,:,:])</span></div>

	<span class="k">def</span> <span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullFilePath</span><span class="p">,</span> <span class="n">imageData</span><span class="p">,</span> <span class="n">includeSpacing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Save a volume with xyz voxel size 2.6755 x 2.6755 x 3.9474 µm^3 to an ImageJ file:</span>

<span class="sd">		&gt;&gt;&gt; volume = numpy.random.randn(57*256*256).astype(&#39;float32&#39;)</span>
<span class="sd">		&gt;&gt;&gt; volume.shape = 1, 57, 1, 256, 256, 1  # dimensions in TZCYXS order</span>
<span class="sd">		&gt;&gt;&gt; imwrite(&#39;temp.tif&#39;, volume, imagej=True, resolution=(1./2.6755, 1./2.6755), metadata={&#39;spacing&#39;: 3.947368, &#39;unit&#39;: &#39;um&#39;})</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1">#print(&#39;imageData.dtype:&#39;, imageData.dtype)</span>

		<span class="c1"># get metadata from StackHeader</span>
		<span class="n">ijmetadata</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">ijmetadataStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">getMetaData</span><span class="p">()</span>
		<span class="n">ijmetadata</span><span class="p">[</span><span class="s1">&#39;Info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ijmetadataStr</span>

		<span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">xVoxel</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">yVoxel</span><span class="p">)</span>
		<span class="n">zVoxel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">zVoxel</span>
		<span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s1">&#39;spacing&#39;</span><span class="p">:</span> <span class="n">zVoxel</span> <span class="k">if</span> <span class="n">includeSpacing</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
			<span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;um&#39;</span>
		<span class="p">}</span>
		<span class="c1"># my volumes are zxy, fiji wants TZCYXS</span>
		<span class="c1">#volume.shape = 1, 57, 1, 256, 256, 1  # dimensions in TZCYXS order</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imageData</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
			<span class="n">numSlices</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="n">numx</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">numy</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">imageData</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
			<span class="n">numSlices</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">numx</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">numy</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error, we can only save 2d or 3d images and stacks!&#39;</span><span class="p">)</span>
		<span class="n">tmpStack</span> <span class="o">=</span> <span class="n">imageData</span>
		<span class="n">tmpStack</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numSlices</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numx</span><span class="p">,</span> <span class="n">numy</span><span class="p">,</span> <span class="mi">1</span>
		<span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fullFilePath</span><span class="p">,</span> <span class="n">tmpStack</span><span class="p">,</span> <span class="n">imagej</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">ijmetadata</span><span class="o">=</span><span class="n">ijmetadata</span><span class="p">)</span>

<div class="viewcode-block" id="bStack.saveMax"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.saveMax">[docs]</a>	<span class="k">def</span> <span class="nf">saveMax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">savePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_makeSavePath</span><span class="p">()</span>
		<span class="n">savePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savePath</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">savePath</span><span class="p">):</span>
			<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">savePath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">channelIdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numChannels</span><span class="p">):</span>
			<span class="n">maxFileName</span> <span class="o">=</span> <span class="s1">&#39;max_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNameWithoutExtension</span> <span class="o">+</span> <span class="s1">&#39;_ch&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channelIdx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span>
			<span class="n">maxFilePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savePath</span><span class="p">,</span> <span class="n">maxFileName</span><span class="p">)</span>

			<span class="c1">#</span>
			<span class="c1"># self.stack is czxy, we specify axis=0 because we are explicitly slicing by channel channelIdx (c)</span>
			<span class="n">maxIntensityProjection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">channelIdx</span><span class="p">,:,:,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="c1">#</span>

			<span class="c1">#tifffile.imwrite(maxFilePath, maxIntensityProjection, ijmetadata=ijmetadata)</span>
			<span class="c1">#tifffile.imwrite(maxFilePath, maxIntensityProjection)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">(</span><span class="n">maxFilePath</span><span class="p">,</span> <span class="n">maxIntensityProjection</span><span class="p">,</span> <span class="n">includeSpacing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="bStack.saveAnnotations"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.saveAnnotations">[docs]</a>	<span class="k">def</span> <span class="nf">saveAnnotations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slabList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">slabList</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

	<span class="c1">#</span>
	<span class="c1"># File name utilities</span>
	<span class="c1">#</span>
<div class="viewcode-block" id="bStack.convert_makeSavePath"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.convert_makeSavePath">[docs]</a>	<span class="k">def</span> <span class="nf">convert_makeSavePath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Given full path to src file, return full path to destination directory.</span>
<span class="sd">		The destination directory is a new folder inside the enclosing src folder &lt;srcFolder&gt;.</span>
<span class="sd">		Its name is &#39;&lt;srcFolder&gt;_tif&#39;</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">enclosingPath</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
		<span class="n">tmpPath</span><span class="p">,</span> <span class="n">enclosingFolder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">enclosingPath</span><span class="p">)</span>

		<span class="n">dstFolder</span> <span class="o">=</span> <span class="n">enclosingFolder</span> <span class="o">+</span> <span class="s1">&#39;_tif&#39;</span>
		<span class="n">savePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">enclosingPath</span><span class="p">,</span> <span class="n">dstFolder</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">savePath</span><span class="p">):</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   bStack.convert_makeSavePath() making output folder:&#39;</span><span class="p">,</span> <span class="n">savePath</span><span class="p">)</span>
			<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">savePath</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">savePath</span></div>

<div class="viewcode-block" id="bStack.convert_getSaveFile"><a class="viewcode-back" href="../../bimpy.html#bimpy.bStack.bStack.convert_getSaveFile">[docs]</a>	<span class="k">def</span> <span class="nf">convert_getSaveFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channelNumber</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return full path to the dst file</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">savePath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_makeSavePath</span><span class="p">()</span> <span class="c1"># full path to output folder we will save in</span>
		<span class="n">saveFileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileNameWithoutExtension</span> <span class="o">+</span> <span class="s1">&#39;_ch&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">channelNumber</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span>
		<span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savePath</span><span class="p">,</span> <span class="n">saveFileName</span><span class="p">)</span></div></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	debugging</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="kn">import</span> <span class="nn">javabridge</span>

	<span class="k">try</span><span class="p">:</span>

		<span class="c1"># work</span>
		<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/Volumes/fourt0/Dropbox/data/arsalan/20190416/20190416_b_0021.oir&#39;</span>

		<span class="c1"># home</span>
		<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/Users/cudmore/Dropbox/data/arsalan/20190416/20190416_b_0021.oir&#39;</span>
		<span class="c1">#path = &#39;/Users/cudmore/Dropbox/data/arsalan/20190416/20190416_b_0001.oir&#39;</span>
		<span class="c1">#path = &#39;/Users/cudmore/Dropbox/data/arsalan/20190416/20190416_b_0019.oir&#39;</span>
		<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/Users/cudmore/Dropbox/data/arsalan/20190416/20190416_b_0005.oir&#39;</span>

		<span class="c1"># ZStack</span>
		<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/Users/cudmore/Dropbox/data/nathan/20190401/tmp/20190401__0011.oir&#39;</span>

		<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/Volumes/t3/data/20190429/20190429_tst2/20190429_tst2_0006.oir&#39;</span>

		<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;E:</span><span class="se">\\</span><span class="s1">cudmore</span><span class="se">\\</span><span class="s1">data</span><span class="se">\\</span><span class="s1">20190429</span><span class="se">\\</span><span class="s1">20190429_tst2</span><span class="se">\\</span><span class="s1">20190429_tst2_0002.oir&#39;</span>

		<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/Users/cudmore/box/data/testoir/20190514_0001.oir&#39;</span>
		<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/Users/cudmore/Sites/bImpy-Data/ca-smooth-muscle-oir/ca-smooth-muscle-oir_tif/20190514_0003_ch1.tif&#39;</span>
		<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/Users/cudmore/Sites/bImpy-Data/ca-smooth-muscle-oir/20190514_0003.oir&#39;</span>
		<span class="c1"># good to test caiman alignment</span>
		<span class="c1">#path = &#39;/Users/cudmore/box/data/nathan/030119/030119_HCN4-GCaMP8_SAN_phen10uM.oir&#39;</span>

		<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/Users/cudmore/box/data/nathan/vesselucida/20191017__0001.tif&#39;</span>
		<span class="c1">#path = &#39;/Users/cudmore/box/data/nathan/vesselucida/vesselucida_tif/20191017__0001_ch1.tif&#39;</span>

		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- bstack main is constructing stack&#39;</span><span class="p">)</span>
		<span class="n">myStack</span> <span class="o">=</span> <span class="n">bStack</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

		<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- bstack main is loading max&#39;</span><span class="p">)</span>
		<span class="n">myStack</span><span class="o">.</span><span class="n">loadMax</span><span class="p">()</span>

		<span class="k">with</span> <span class="n">javabridge</span><span class="o">.</span><span class="n">vm</span><span class="p">(</span>
				<span class="n">run_headless</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
				<span class="n">class_path</span><span class="o">=</span><span class="n">bioformats</span><span class="o">.</span><span class="n">JARS</span>
				<span class="p">):</span>

			<span class="c1"># turn off logging, see:</span>
			<span class="c1"># ./bStack_env/lib/python3.7/site-packages/bioformats/log4j.py</span>
			<span class="n">log4j</span> <span class="o">=</span> <span class="n">javabridge</span><span class="o">.</span><span class="n">JClassWrapper</span><span class="p">(</span><span class="s2">&quot;loci.common.Log4jTools&quot;</span><span class="p">)</span>
			<span class="n">log4j</span><span class="o">.</span><span class="n">enableLogging</span><span class="p">()</span>
			<span class="n">log4j</span><span class="o">.</span><span class="n">setRootLevel</span><span class="p">(</span><span class="s2">&quot;WARN&quot;</span><span class="p">)</span>

			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- bstack main is calling convert()&#39;</span><span class="p">)</span>
			<span class="n">myStack</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>

	<span class="k">finally</span><span class="p">:</span>
		<span class="c1">#print(&#39;__main__ finally&#39;)</span>
		<span class="n">javabridge</span><span class="o">.</span><span class="n">kill_vm</span><span class="p">()</span>
		<span class="k">pass</span>

	<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bstack main finished&#39;</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">bImPy</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Robert H Cudmore.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>